# CI æµç¨‹ - Pull Request è‡ªåŠ¨æ£€æµ‹
# å½“æœ‰ PR æäº¤æˆ–æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è¿è¡Œ

name: CI

on:
  push:
    branches: [master, main]
    paths:
      - '**.py'
      - 'requirements.txt'
      - 'pyproject.toml'
      - 'setup.cfg'
      - '.github/workflows/**'
      - 'Dockerfile'
      - 'docker-compose.yml'
  pull_request:
    branches: [master, main]
    paths:
      - '**.py'
      - 'requirements.txt'
      - 'pyproject.toml'
      - 'setup.cfg'
      - '.github/workflows/**'
      - 'Dockerfile'
      - 'docker-compose.yml'

jobs:
  # ==================== æ ¸å¿ƒæ£€æŸ¥ï¼ˆå¿…é¡»é€šè¿‡ï¼‰====================
  check:
    name: âœ… ä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov coverage bandit safety flake8

      - name: ğŸ è¯­æ³•æ£€æŸ¥
        run: |
          python -m py_compile main.py config.py analyzer.py notification.py
          python -m py_compile storage.py scheduler.py search_service.py
          python -m py_compile market_analyzer.py stock_analyzer.py
          python -m py_compile data_provider/*.py
          python -m py_compile technical_indicators.py report_formatter.py
          python -m py_compile utils/*.py
          python -m py_compile notification/*.py
          echo "âœ… Python è¯­æ³•æ£€æŸ¥é€šè¿‡"

      - name: ğŸ” é™æ€åˆ†æ (ä¸¥é‡é”™è¯¯)
        run: |
          # åªæ£€æŸ¥ä¸¥é‡é”™è¯¯ï¼šè¯­æ³•é”™è¯¯ã€æœªå®šä¹‰å˜é‡ç­‰
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: âœ… æ¨¡å—å¯¼å…¥æµ‹è¯•
        run: |
          python -c "from config import get_config; print('âœ… config')"
          python -c "from storage import DatabaseManager; print('âœ… storage')"
          python -c "from notification import NotificationService; print('âœ… notification')"
          python -c "from data_provider import DataFetcherManager; print('âœ… data_provider')"
          python -c "from analyzer import GeminiAnalyzer; print('âœ… analyzer')"
          python -c "from technical_indicators import TechnicalIndicatorInterpreter; print('âœ… technical_indicators')"
          python -c "from report_formatter import ReportFormatter; print('âœ… report_formatter')"
          python -c "from utils import get_cache_manager; print('âœ… utils.cache_manager')"
          echo "âœ… æ‰€æœ‰æ¨¡å—å¯¼å…¥æˆåŠŸ"

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•
        run: |
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=term-missing --cov-fail-under=20

      - name: ğŸ“Š ä¸Šä¼ è¦†ç›–ç‡åˆ° Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: ğŸ”’ å®‰å…¨æ‰«æ (Bandit)
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -f txt

      - name: ğŸ›¡ï¸ ä¾èµ–å®‰å…¨æ£€æŸ¥ (Safety)
        run: |
          safety check --json || true
          safety check

  # ==================== æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥ ====================
  coverage:
    name: ğŸ“Š æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [check]

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
        run: |
          pytest tests/ --cov=. --cov-report=html --cov-report=term --cov-fail-under=20

      - name: ğŸ“¤ ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: htmlcov/

  # ==================== Docker æ„å»ºæµ‹è¯• ====================
  docker:
    name: ğŸ³ Docker æ„å»º
    runs-on: ubuntu-latest
    needs: [check]
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ³ æ„å»ºé•œåƒ
        run: |
          docker build -t stock-analysis:test .
          docker run --rm stock-analysis:test python -c "print('âœ… Docker OK')"
